<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DCF Valuation Wizard</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#121833;--panel-2:#0f1530;--text:#eaf0ff;--muted:#9bb0ff;--accent:#7aa2ff;--good:#00d68f;--bad:#ff6b6b;--warn:#ffc857;--line:#223;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020 0%,#0a0f24 100%);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 12px;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);margin-bottom:22px}
    .wizard{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .sidebar{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:10px}
    .step{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:var(--muted);cursor:pointer;border:1px solid transparent}
    .step.active{background:var(--panel-2);color:var(--text);border-color:#1d2748}
    .step .num{width:28px;height:28px;border-radius:9px;background:#1a2344;color:#bcd3ff;display:grid;place-items:center;font-weight:700;font-size:12px}
    .content{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{grid-column:span 12;background:var(--panel-2);border:1px solid #1b2547;border-radius:14px;padding:14px}
    label{display:block;font-size:12px;color:#c7d6ff;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #233055;background:#0c1330;color:var(--text);outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(122,162,255,.15)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#233b7a,#1a2e61);border:1px solid #2a3f7a;color:#eaf0ff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.secondary{background:#111935;border-color:#233055;color:#cfe1ff}
    .btn.ghost{background:transparent;border-color:#2a3f7a;color:#aecdff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .help{font-size:12px;color:#9bb0ff}
    .hr{height:1px;background:#1b2547;margin:14px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1b2547;text-align:right}
    th:first-child,td:first-child{text-align:left}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #2c3d79;background:#111a3b;color:#bcd3ff;font-size:12px}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi .box{background:#0e1535;border:1px solid #1d2748;border-radius:14px;padding:12px}
    .box h3{margin:0 0 6px;font-size:12px;color:#bcd3ff;font-weight:600}
    .box .v{font-size:20px;font-weight:800}
    .muted{color:#a4b8ff}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .footer{margin-top:18px;color:#9bb0ff;font-size:12px}
    .tag{font-size:11px;color:#9bb0ff}
    .sens{overflow:auto}
    .heatmap td{width:80px;height:40px;text-align:center;border:1px solid #1b2547;font-weight:600}
    .heatmap td span{display:block;width:100%;height:100%;line-height:40px}
    .disclaimer{font-size:12px;color:#98a9e8}
    details>summary{cursor:pointer;margin:6px 0;color:#bcd3ff}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>DCF Valuation Wizard</h1>
    <div class="sub">Comprehensive discounted cash flow calculator with CSV export & 3×3 sensitivity heatmap.</div>

    <div class="wizard">
      <div class="sidebar" id="sidebar"></div>
      <div class="content">
        <div id="view"></div>
        <div class="hr"></div>
        <div class="actions">
          <button class="btn secondary" id="prevBtn">◀ Previous</button>
          <button class="btn" id="nextBtn">Next ▶</button>
          <button class="btn ghost" id="exportBtn">Export Inputs (JSON)</button>
        </div>
        <div class="footer">All calculations run locally in your browser. For educational use only.</div>
      </div>
    </div>
  </div>

  <script>
    // ---------------- State ----------------
    const state={
      company:{name:"",currency:"$",sharesOut:1000,netDebt:0},
      mode:"simple", // 'simple' | 'detailed'
      forecast:{years:5,midYear:true},
      discount:{wacc:10},
      terminal:{method:"perpetuity",g:2.5,exitMultiple:10,base:"FCF"},
      simpleFCF:[50,55,60,63,66],
      detailed:{startRevenue:1000,startFCFMargin:8,growth1:12,years1:3,growth2:8,years2:2,fcfMarginTarget:10,rampToTarget:true}
    };

    const fmt=(n,c=state.company.currency)=>c+" "+Number(n).toLocaleString(undefined,{maximumFractionDigits:2});
    const pct=n=>Number(n).toLocaleString(undefined,{maximumFractionDigits:2})+"%";
    const clone=o=>JSON.parse(JSON.stringify(o));

    // Dynamic steps: Simple or Detailed inputs become conditional steps
    const baseSteps=[
      {key:"company",title:"Company & Capital Structure",render:renderCompany},
      {key:"mode",title:"Choose Forecast Mode",render:renderMode},
      {key:"forecast",title:"Forecast Horizon & Timing",render:renderForecast},
      {key:"inputsSimple",title:"Provide Simple Inputs",render:renderSimpleInputs,visible:()=>state.mode==='simple'},
      {key:"inputsDetailed",title:"Provide Detailed Inputs",render:renderDetailedInputs,visible:()=>state.mode==='detailed'},
      {key:"discount",title:"Discount Rate (WACC)",render:renderDiscount},
      {key:"terminal",title:"Terminal Value",render:renderTerminal},
      {key:"review",title:"Review & Calculate",render:renderReview},
      {key:"analysis",title:"Analysis & Export",render:renderAnalysis}
    ];

    function getSteps(){return baseSteps.filter(s=>s.visible? s.visible(): true)}
    let current=0;

    function clampCurrent(){const steps=getSteps();if(current>=steps.length)current=steps.length-1;}

    function drawSidebar(){const steps=getSteps();const sb=document.getElementById('sidebar');sb.innerHTML=steps.map((s,i)=>`<div class='step ${i===current?'active':''}' data-idx='${i}'><div class='num'>${i+1}</div><div>${s.title}</div></div>`).join('');sb.querySelectorAll('.step').forEach(el=>el.onclick=()=>{current=+el.dataset.idx;draw();});}

    function onInput(p,v){
      const a=p.split('.');
      let o=state;
      for(let i=0;i<a.length-1;i++)o=o[a[i]];
      o[a[a.length-1]]=v;
      
      // Only redraw in certain steps (e.g., review or analysis)
      const currentKey = getSteps()[current]?.key;
      if (currentKey === 'review' || currentKey === 'analysis') draw();
    }

    // ---------------- Renders ----------------
    function renderCompany(){return`
      <div class='card'>
        <div class='grid-2'>
          <div><label>Company name</label><input value='${state.company.name}' oninput="onInput('company.name',this.value)"></div>
          <div><label>Currency symbol</label><input value='${state.company.currency}' oninput="onInput('company.currency',this.value)" placeholder='$ / € / ₹'></div>
          <div><label>Shares outstanding (millions)</label><input type='number' step='0.01' value='${state.company.sharesOut}' oninput="onInput('company.sharesOut',parseFloat(this.value)||0)"></div>
          <div><label>Net Debt (Debt − Cash), millions</label><input type='number' step='0.01' value='${state.company.netDebt}' oninput="onInput('company.netDebt',parseFloat(this.value)||0)"><div class='help'>If you include minority interest or prefs in net debt, the bridge to equity is handled here.</div></div>
        </div>
      </div>`}

    function renderMode(){return`
      <div class='card'>
        <label>Forecast mode</label>
        <select onchange="onInput('mode',this.value)">
          <option value='simple' ${state.mode==='simple'?'selected':''}>Simple — I will enter yearly FCFF (FCFF)</option>
          <option value='detailed' ${state.mode==='detailed'?'selected':''}>Detailed — Derive FCFF from revenue growth & FCF margin</option>
        </select>
        <div class='hr'></div>
        <div class='help'>FCFF is cash flow available to all capital providers. We discount by WACC to get EV, then subtract Net Debt to get Equity Value.</div>
      </div>`}

    function renderForecast(){return`
      <div class='card'>
        <div class='grid-2'>
          <div><label>Projection years (N)</label><input type='number' min='1' max='15' value='${state.forecast.years}' oninput="setYears(parseInt(this.value)||1)"></div>
          <div><label>Mid‑year convention</label><select onchange="onInput('forecast.midYear',this.value==='true')"><option value='true' ${state.forecast.midYear?'selected':''}>On (discount half‑period earlier)</option><option value='false' ${!state.forecast.midYear?'selected':''}>Off</option></select></div>
        </div>
        <div class='hr'></div>
        <div class='help'>Mid‑year assumes cash flows occur throughout the year. Off assumes end of year.</div>
      </div>`}

    function renderSimpleInputs(){if(state.mode!=='simple') return '';
      let rows='';for(let i=0;i<state.forecast.years;i++){const v=state.simpleFCF[i]??0;rows+=`<tr><td>Year ${i+1}</td><td><input type='number' step='0.01' value='${v}' oninput='setSimple(${i},parseFloat(this.value)||0)'></td></tr>`}
      return `<div class='card'>
        <div class='help'>Enter Free Cash Flow to the Firm (FCFF) per year in <i>millions</i> of ${state.company.currency}.</div>
        <div class='hr'></div>
        <table><thead><tr><th>Year</th><th>FCFF (millions)</th></tr></thead><tbody>${rows}</tbody></table>
        <div class='hr'></div>
        <button class='btn ghost' onclick='autoGrowFCF()'>Auto‑fill with growth pattern</button>
      </div>`}

    function autoGrowFCF(){const start=state.simpleFCF[0]??50;const g=8;for(let i=0;i<state.forecast.years;i++){state.simpleFCF[i]=+(start*Math.pow(1+g/100,i)).toFixed(2);}draw();}
    function setSimple(i,v){state.simpleFCF[i]=v;draw();}

    function renderDetailedInputs(){if(state.mode!=='detailed') return '';
      const d=state.detailed;
      return `<div class='card'>
        <div class='grid-2'>
          <div><label>Start year revenue (millions)</label><input type='number' step='0.01' value='${d.startRevenue}' oninput="onInput('detailed.startRevenue',parseFloat(this.value)||0)"></div>
          <div><label>Start FCF margin (% of revenue)</label><input type='number' step='0.01' value='${d.startFCFMargin}' oninput="onInput('detailed.startFCFMargin',parseFloat(this.value)||0)"></div>
          <div><label>Phase 1 revenue CAGR (%)</label><input type='number' step='0.01' value='${d.growth1}' oninput="onInput('detailed.growth1',parseFloat(this.value)||0)"></div>
          <div><label>Phase 1 years</label><input type='number' value='${d.years1}' oninput="onInput('detailed.years1',parseInt(this.value)||0)"></div>
          <div><label>Phase 2 revenue CAGR (%)</label><input type='number' step='0.01' value='${d.growth2}' oninput="onInput('detailed.growth2',parseFloat(this.value)||0)"></div>
          <div><label>Phase 2 years</label><input type='number' value='${d.years2}' oninput="onInput('detailed.years2',parseInt(this.value)||0)"></div>
          <div><label>Target FCF margin by last year (%)</label><input type='number' step='0.01' value='${d.fcfMarginTarget}' oninput="onInput('detailed.fcfMarginTarget',parseFloat(this.value)||0)"></div>
          <div><label>Ramp margins linearly to target?</label><select onchange="onInput('detailed.rampToTarget',this.value==='true')"><option value='true' ${d.rampToTarget?'selected':''}>Yes (linear)</option><option value='false' ${!d.rampToTarget?'selected':''}>No (use start margin)</option></select></div>
        </div>
        <div class='hr'></div>
        <div class='help'>FCFF is derived as Revenue × FCF margin each year. This simplified model implicitly covers reinvestment.</div>
      </div>`}

    function renderDiscount(){return `<div class='card'>
        <div class='grid-2'>
          <div><label>WACC / Discount rate (%)</label><input type='number' step='0.01' value='${state.discount.wacc}' oninput="onInput('discount.wacc',parseFloat(this.value)||0)"></div>
          <div><label>Preview</label><div class='pill'>${pct(state.discount.wacc)}</div></div>
        </div>
        <div class='hr'></div>
        <div class='help'>Typical WACC range for mature firms 7–12% — adjust to reflect risk & leverage.</div>
      </div>`}

    function renderTerminal(){return `<div class='card'>
      <label>Terminal value method</label>
      <select onchange="onInput('terminal.method',this.value)">
        <option value='perpetuity' ${state.terminal.method==='perpetuity'?'selected':''}>Perpetuity growth (Gordon)</option>
        <option value='exit' ${state.terminal.method==='exit'?'selected':''}>Exit multiple</option>
      </select>
      <div class='hr'></div>
      ${state.terminal.method==='perpetuity' ? `
        <div class='grid-2'>
          <div><label>Long‑run growth g (%)</label><input type='number' step='0.01' value='${state.terminal.g}' oninput="onInput('terminal.g',parseFloat(this.value)||0)"></div>
          <div class='help'>Constraint: g < WACC to keep the model finite.</div>
        </div>` : `
        <div class='grid-2'>
          <div><label>Exit multiple</label><input type='number' step='0.01' value='${state.terminal.exitMultiple}' oninput="onInput('terminal.exitMultiple',parseFloat(this.value)||0)"></div>
          <div><label>Multiple applied to</label><select onchange="onInput('terminal.base',this.value)"><option value='FCF' ${state.terminal.base==='FCF'?'selected':''}>Final‑year FCFF</option><option value='Revenue' ${state.terminal.base==='Revenue'?'selected':''}>Final‑year Revenue</option></select></div>
        </div>`}
    </div>`}

    function renderReview(){const r=calculate();let rows='';r.series.forEach((x,i)=>rows+=`<tr><td>${i+1}</td><td>${fmt(x.revenue)}</td><td>${pct(x.fcfMargin)}</td><td>${fmt(x.fcff)}</td><td>${pct(x.discountFactor*100)}</td><td>${fmt(x.pv)}</td></tr>`);
      return `<div class='card'>
        <div class='kpi'>
          <div class='box'><h3>PV of Explicit FCFF</h3><div class='v'>${fmt(r.pvFCF)}</div></div>
          <div class='box'><h3>PV of Terminal Value</h3><div class='v'>${fmt(r.pvTV)}</div></div>
          <div class='box'><h3>Enterprise Value</h3><div class='v'>${fmt(r.ev)}</div></div>
          <div class='box'><h3>Equity Value / Share</h3><div class='v'>${fmt(r.valuePerShare)}</div></div>
        </div>
        <div class='hr'></div>
        <details>
          <summary>View all inputs summary</summary>
          ${inputsSummaryTable()}
        </details>
        <div class='hr'></div>
        <div class='sens'>
          <table>
            <thead><tr><th>Year</th><th>Revenue</th><th>FCF Margin</th><th>FCFF</th><th>Discount Factor</th><th>Present Value</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <div class='hr'></div>
        <div class='help'>Terminal (${state.terminal.method==='perpetuity' ? `g=${state.terminal.g}%`:`Exit ×${state.terminal.exitMultiple} on ${state.terminal.base}`}) → PV: <b>${fmt(r.pvTV)}</b></div>
      </div>`}

    function renderAnalysis(){const r=calculate();return `<div class='card'>
      <h3>3×3 Sensitivity Heatmap</h3>
      ${heatmap(r)}
      <div class='hr'></div>
      <button class='btn' onclick='exportCSV()'>Download CSV Results</button>
      <button class='btn ghost' onclick='exportJSON()'>Export Inputs (JSON)</button>
    </div>`}

    function inputsSummaryTable(){const d=state.detailed;return `<table><tbody>
      <tr><td>Mode</td><td>${state.mode}</td></tr>
      <tr><td>Years</td><td>${state.forecast.years}</td></tr>
      <tr><td>Mid‑year</td><td>${state.forecast.midYear?'On':'Off'}</td></tr>
      <tr><td>WACC</td><td>${pct(state.discount.wacc)}</td></tr>
      ${state.terminal.method==='perpetuity'?`<tr><td>Terminal g</td><td>${pct(state.terminal.g)}</td></tr>`:`<tr><td>Exit multiple</td><td>${state.terminal.exitMultiple}× on ${state.terminal.base}</td></tr>`}
      ${state.mode==='detailed'?`
        <tr><td>Start Revenue</td><td>${fmt(d.startRevenue)}</td></tr>
        <tr><td>Start FCF Margin</td><td>${pct(d.startFCFMargin)}</td></tr>
        <tr><td>Phase 1</td><td>${pct(d.growth1)} for ${d.years1} yrs</td></tr>
        <tr><td>Phase 2</td><td>${pct(d.growth2)} for ${d.years2} yrs</td></tr>
        <tr><td>Target FCF Margin</td><td>${pct(d.fcfMarginTarget)}</td></tr>
        <tr><td>Ramp Margins</td><td>${d.rampToTarget?'Yes':'No'}</td></tr>`:
        `<tr><td>Simple FCFF (first yr)</td><td>${fmt(state.simpleFCF[0]||0)}</td></tr>`}
      <tr><td>Shares (m)</td><td>${state.company.sharesOut}</td></tr>
      <tr><td>Net Debt (m)</td><td>${fmt(state.company.netDebt)}</td></tr>
    </tbody></table>`}

    // ---------------- Engine ----------------
    function setYears(n){n=Math.max(1,Math.min(15,n));state.forecast.years=n;const arr=new Array(n).fill(0).map((_,i)=>state.simpleFCF[i]??0);state.simpleFCF=arr;draw();}

    function buildSeries(s=state){
      const n=s.forecast.years;const series=[];
      if(s.mode==='simple'){
        for(let i=0;i<n;i++){const f=s.simpleFCF[i]??0;series.push({revenue:0,fcfMargin:0,fcff:f});}
      }else{
        const d=s.detailed;let r=d.startRevenue;const rev=[];for(let i=0;i<n;i++){if(i>0){const g=(i-1<d.years1)?d.growth1:d.growth2;r=r*(1+g/100);}rev.push(r);} // revenue path
        const margins=[];if(d.rampToTarget){const a=d.startFCFMargin,b=d.fcfMarginTarget;for(let i=0;i<n;i++){margins.push(a+(b-a)*(i/(n-1)));}}
        else{for(let i=0;i<n;i++)margins.push(d.startFCFMargin);}
        for(let i=0;i<n;i++){const m=margins[i];const f=rev[i]*(m/100);series.push({revenue:rev[i],fcfMargin:m,fcff:f});}
      }
      return series;
    }

    function calculate(s=state){
      const k=s.discount.wacc/100;const n=s.forecast.years;const mid=s.forecast.midYear;const series=buildSeries(s);
      // Discount explicit CFs
      const disc=series.map((row,idx)=>{const t=idx+1;const df=1/Math.pow(1+k,t-(mid?0.5:0));return {...row,discountFactor:df,pv:row.fcff*df}});
      const pvFCF=disc.reduce((a,b)=>a+b.pv,0);
      // Terminal value
      let tv=0;const last=series[n-1];
      if(s.terminal.method==='perpetuity'){
        const g=s.terminal.g/100; if(g>=k){ /* avoid div by zero; treat as tiny epsilon less than k */ }
        tv=(last.fcff*(1+g))/(k-g);
      }else{
        const base=s.terminal.base;const metric=(base==='FCF')? last.fcff : last.revenue; tv=metric*s.terminal.exitMultiple;
      }
      const dfTV=1/Math.pow(1+k,n-(mid?0.5:0)); const pvTV=tv*dfTV;
      const ev=pvFCF+pvTV; const equity=ev - s.company.netDebt; const valuePerShare=equity/(s.company.sharesOut||1);
      return {series:disc,pvFCF,pvTV,ev,equity,valuePerShare,k:k*100,g:s.terminal.g};
    }

    // ---------------- Analysis helpers ----------------
    function heatmap(r){
      const baseW=r.k, baseG=r.g; let html="<table class='heatmap'><tr><th>g\\WACC</th>"; const ws=[+(baseW-1).toFixed(2),+baseW.toFixed(2),+(baseW+1).toFixed(2)]; ws.forEach(w=>html+=`<th>${w}%</th>`); html+="</tr>";
      if(state.terminal.method==='perpetuity'){
        const gs=[+(baseG-0.5).toFixed(2),+baseG.toFixed(2),+(baseG+0.5).toFixed(2)];
        gs.forEach(g=>{html+=`<tr><td>${g}%</td>`; ws.forEach(w=>{const tmp=clone(state); tmp.discount.wacc=w; tmp.terminal.g=g; const val=calculate(tmp).valuePerShare; const color=val>r.valuePerShare?'var(--good)':val<r.valuePerShare?'var(--bad)':'var(--warn)'; html+=`<td><span style='background:${color};color:#fff'>${fmt(val)}</span></td>`}); html+="</tr>"});
      } else {
        html+=`<tr><td>N/A</td>`; ws.forEach(w=>{const tmp=clone(state); tmp.discount.wacc=w; const val=calculate(tmp).valuePerShare; const color=val>r.valuePerShare?'var(--good)':val<r.valuePerShare?'var(--bad)':'var(--warn)'; html+=`<td><span style='background:${color};color:#fff'>${fmt(val)}</span></td>`}); html+="</tr>";
      }
      html+="</table>"; return html;
    }

    function exportCSV(){
      const r=calculate();
      let csv="Year,Revenue,FCFMargin,FCFF,DiscountFactor,PV\n";
      r.series.forEach((x,i)=>{csv+=`${i+1},${x.revenue},${x.fcfMargin},${x.fcff},${x.discountFactor},${x.pv}\n`});
      csv+=`PV_Explicit,${r.pvFCF}\n`;
      csv+=`PV_Terminal,${r.pvTV}\n`;
      csv+=`EnterpriseValue,${r.ev}\n`;
      csv+=`EquityValue,${r.equity}\n`;
      csv+=`ValuePerShare,${r.valuePerShare}\n`;
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dcf_results.csv'; a.click();
    }

    function exportJSON(){
      const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dcf_inputs.json'; a.click();
    }

    // ---------------- Orchestration ----------------
    function draw(){clampCurrent(); drawSidebar(); const steps=getSteps(); document.getElementById('view').innerHTML=steps[current].render(); document.getElementById('prevBtn').disabled=current===0; document.getElementById('nextBtn').disabled=current===steps.length-1;}

    document.getElementById('prevBtn').onclick=()=>{const steps=getSteps(); if(current>0){current--; draw();}};
    document.getElementById('nextBtn').onclick=()=>{const steps=getSteps(); if(current<steps.length-1){current++; draw();}};
    document.getElementById('exportBtn').onclick=exportJSON;

    draw();
  </script>
</body>
</html>
